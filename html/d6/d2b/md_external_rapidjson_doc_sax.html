<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Monero: SAX</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Monero
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">SAX </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#Reader">Reader</a><ul><li class="level2"><a href="#Handler">Handler</a></li>
<li class="level2"><a href="#GenericReader">GenericReader</a></li>
<li class="level2"><a href="#SaxParsing">Parsing</a></li>
<li class="level2"><a href="#TokenByTokenParsing">Token-by-Token Parsing</a></li>
</ul>
</li>
<li class="level1"><a href="#Writer">Writer</a><ul><li class="level2"><a href="#WriterTemplate">Template</a></li>
<li class="level2"><a href="#PrettyWriter">PrettyWriter</a></li>
<li class="level2"><a href="#CompletenessReset">Completeness and Reset</a></li>
</ul>
</li>
<li class="level1"><a href="#SaxTechniques">Techniques</a><ul><li class="level2"><a href="#CustomDataStructure">Parsing JSON to Custom Data Structure</a></li>
<li class="level2"><a href="#Filtering">Filtering of JSON</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>The term "SAX" originated from <a href="http://en.wikipedia.org/wiki/Simple_API_for_XML">Simple API for XML</a>. We borrowed this term for JSON parsing and generation.</p>
<p>In RapidJSON, <code>Reader</code> (typedef of <code><a class="el" href="../../dc/d9e/classGenericReader.html" title="SAX-style JSON parser. Use Reader for UTF8 encoding and default allocator. ">GenericReader</a>&lt;...&gt;</code>) is the SAX-style parser for JSON, and <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> (typedef of <code>GenericWriter&lt;...&gt;</code>) is the SAX-style generator for JSON.</p>
<h1><a class="anchor" id="Reader"></a>
Reader</h1>
<p><code>Reader</code> parses a JSON from a stream. While it reads characters from the stream, it analyzes the characters according to the syntax of JSON, and publishes events to a handler.</p>
<p>For example, here is a JSON.</p>
<div class="fragment"><div class="line">{</div><div class="line">    &quot;hello&quot;: &quot;world&quot;,</div><div class="line">    &quot;t&quot;: true ,</div><div class="line">    &quot;f&quot;: false,</div><div class="line">    &quot;n&quot;: null,</div><div class="line">    &quot;i&quot;: 123,</div><div class="line">    &quot;pi&quot;: 3.1416,</div><div class="line">    &quot;a&quot;: [1, 2, 3, 4]</div><div class="line">}</div></div><!-- fragment --><p>When a <code>Reader</code> parses this JSON, it publishes the following events to the handler sequentially:</p>
<div class="fragment"><div class="line">StartObject()</div><div class="line">Key(&quot;hello&quot;, 5, true)</div><div class="line">String(&quot;world&quot;, 5, true)</div><div class="line">Key(&quot;t&quot;, 1, true)</div><div class="line">Bool(true)</div><div class="line">Key(&quot;f&quot;, 1, true)</div><div class="line">Bool(false)</div><div class="line">Key(&quot;n&quot;, 1, true)</div><div class="line">Null()</div><div class="line">Key(&quot;i&quot;)</div><div class="line">UInt(123)</div><div class="line">Key(&quot;pi&quot;)</div><div class="line">Double(3.1416)</div><div class="line">Key(&quot;a&quot;)</div><div class="line">StartArray()</div><div class="line">Uint(1)</div><div class="line">Uint(2)</div><div class="line">Uint(3)</div><div class="line">Uint(4)</div><div class="line">EndArray(4)</div><div class="line">EndObject(7)</div></div><!-- fragment --><p>These events can be easily matched with the JSON, but some event parameters need further explanation. Let's see the <code>simplereader</code> example which produces exactly the same output as above:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d6/dda/reader_8h.html">rapidjson/reader.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="../../d1/dc3/namespacerapidjson.html">rapidjson</a>;</div><div class="line"><span class="keyword">using namespace </span><a class="code" href="../../d8/dcc/namespacestd.html">std</a>;</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="../../de/d7d/structMyHandler.html">MyHandler</a> : <span class="keyword">public</span> <a class="code" href="../../d0/d14/structBaseReaderHandler.html">BaseReaderHandler</a>&lt;UTF8&lt;&gt;, MyHandler&gt; {</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d5/d14/namespacerandomx_1_1ExecutionPort.html#a1732431f7d93bacc6861edbe71154449">Null</a>() { cout &lt;&lt; <span class="stringliteral">&quot;Null()&quot;</span> &lt;&lt; endl; <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d9/d2b/structBool.html">Bool</a>(<span class="keywordtype">bool</span> <a class="code" href="../../d9/d4d/block_8cpp.html#a2ea31dd046acb6f7efda9c8ccb0304dc">b</a>) { cout &lt;&lt; <span class="stringliteral">&quot;Bool(&quot;</span> &lt;&lt; boolalpha &lt;&lt; b &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl; <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div><div class="line">    <span class="keywordtype">bool</span> Int(<span class="keywordtype">int</span> <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a2c17f82375a6691bffaa1927a2247b28">i</a>) { cout &lt;&lt; <span class="stringliteral">&quot;Int(&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl; <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div><div class="line">    <span class="keywordtype">bool</span> Uint(<span class="keywordtype">unsigned</span> <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a747820e693705cfaea4159322b20fab8">u</a>) { cout &lt;&lt; <span class="stringliteral">&quot;Uint(&quot;</span> &lt;&lt; u &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl; <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#abd4adb4f2e2d7078a473de91a4089501">Int64</a>(<a class="code" href="../../df/dd8/stdint_8h.html#a414156feea104f8f75b4ed9e3121b2f6">int64_t</a> <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a2c17f82375a6691bffaa1927a2247b28">i</a>) { cout &lt;&lt; <span class="stringliteral">&quot;Int64(&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl; <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div><div class="line">    <span class="keywordtype">bool</span> Uint64(<a class="code" href="../../df/dd8/stdint_8h.html#aec6fcb673ff035718c238c8c9d544c47">uint64_t</a> <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a747820e693705cfaea4159322b20fab8">u</a>) { cout &lt;&lt; <span class="stringliteral">&quot;Uint64(&quot;</span> &lt;&lt; u &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl; <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a92debc9f055b7e7e1e4e861c5ae1c67a">Double</a>(<span class="keywordtype">double</span> d) { cout &lt;&lt; <span class="stringliteral">&quot;Double(&quot;</span> &lt;&lt; d &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl; <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div><div class="line">    <span class="keywordtype">bool</span> String(<span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="../../d6/dbe/portlistingparse_8c.html#a7906a77d388c7c6f7eea5850f61f55e1">str</a>, <a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> length, <span class="keywordtype">bool</span> <a class="code" href="../../d3/d65/namespacerct.html#ad77d0fb2279743febea3fb652f96c77b">copy</a>) { </div><div class="line">        cout &lt;&lt; <span class="stringliteral">&quot;String(&quot;</span> &lt;&lt; str &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; length &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; boolalpha &lt;&lt; copy &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl;</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keywordtype">bool</span> StartObject() { cout &lt;&lt; <span class="stringliteral">&quot;StartObject()&quot;</span> &lt;&lt; endl; <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d0/d75/namespacetesting.html#a6212e76b542f4ffd3079de59092a826a">Key</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="../../d6/dbe/portlistingparse_8c.html#a7906a77d388c7c6f7eea5850f61f55e1">str</a>, <a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> length, <span class="keywordtype">bool</span> <a class="code" href="../../d3/d65/namespacerct.html#ad77d0fb2279743febea3fb652f96c77b">copy</a>) { </div><div class="line">        cout &lt;&lt; <span class="stringliteral">&quot;Key(&quot;</span> &lt;&lt; str &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; length &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; boolalpha &lt;&lt; copy &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl;</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keywordtype">bool</span> EndObject(<a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> memberCount) { cout &lt;&lt; <span class="stringliteral">&quot;EndObject(&quot;</span> &lt;&lt; memberCount &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl; <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div><div class="line">    <span class="keywordtype">bool</span> StartArray() { cout &lt;&lt; <span class="stringliteral">&quot;StartArray()&quot;</span> &lt;&lt; endl; <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div><div class="line">    <span class="keywordtype">bool</span> EndArray(<a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> elementCount) { cout &lt;&lt; <span class="stringliteral">&quot;EndArray(&quot;</span> &lt;&lt; elementCount &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl; <span class="keywordflow">return</span> <span class="keyword">true</span>; }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="../../d2/dd2/CheckLinkerFlag_8c.html#adacbe0175a79dff748855d8c9839f82b">main</a>() {</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="../../d1/da9/transport_8cpp.html#afd59c6c3ac6616bcae5b57d264500a83">json</a>[] = <span class="stringliteral">&quot; { \&quot;hello\&quot; : \&quot;world\&quot;, \&quot;t\&quot; : true , \&quot;f\&quot; : false, \&quot;n\&quot;: null, \&quot;i\&quot;:123, \&quot;pi\&quot;: 3.1416, \&quot;a\&quot;:[1, 2, 3, 4] } &quot;</span>;</div><div class="line"></div><div class="line">    <a class="code" href="../../de/d7d/structMyHandler.html">MyHandler</a> handler;</div><div class="line">    <a class="code" href="../../dc/d9e/classGenericReader.html">Reader</a> reader;</div><div class="line">    <a class="code" href="../../d2/d8a/structGenericStringStream.html">StringStream</a> ss(json);</div><div class="line">    reader.<a class="code" href="../../dc/d9e/classGenericReader.html#a0c450620d14ff1824e58bb7bd9b42099">Parse</a>(ss, handler);</div><div class="line">}</div></div><!-- fragment --><p>Note that RapidJSON uses templates to statically bind the <code>Reader</code> type and the handler type, instead of using classes with virtual functions. This paradigm can improve performance by inlining functions.</p>
<h2><a class="anchor" id="Handler"></a>
Handler</h2>
<p>As shown in the previous example, the user needs to implement a handler which consumes the events (via function calls) from the <code>Reader</code>. The handler must contain the following member functions.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>Handler {</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d5/d14/namespacerandomx_1_1ExecutionPort.html#a1732431f7d93bacc6861edbe71154449">Null</a>();</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d9/d2b/structBool.html">Bool</a>(<span class="keywordtype">bool</span> <a class="code" href="../../d9/d4d/block_8cpp.html#a2ea31dd046acb6f7efda9c8ccb0304dc">b</a>);</div><div class="line">    <span class="keywordtype">bool</span> Int(<span class="keywordtype">int</span> <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a2c17f82375a6691bffaa1927a2247b28">i</a>);</div><div class="line">    <span class="keywordtype">bool</span> Uint(<span class="keywordtype">unsigned</span> <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a2c17f82375a6691bffaa1927a2247b28">i</a>);</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#abd4adb4f2e2d7078a473de91a4089501">Int64</a>(<a class="code" href="../../df/dd8/stdint_8h.html#a414156feea104f8f75b4ed9e3121b2f6">int64_t</a> <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a2c17f82375a6691bffaa1927a2247b28">i</a>);</div><div class="line">    <span class="keywordtype">bool</span> Uint64(<a class="code" href="../../df/dd8/stdint_8h.html#aec6fcb673ff035718c238c8c9d544c47">uint64_t</a> <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a2c17f82375a6691bffaa1927a2247b28">i</a>);</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a92debc9f055b7e7e1e4e861c5ae1c67a">Double</a>(<span class="keywordtype">double</span> d);</div><div class="line">    <span class="keywordtype">bool</span> RawNumber(<span class="keyword">const</span> <a class="code" href="../../d8/df3/sha512-blocks_8c.html#ab0a0d1ad13c7e4d3cb38c89f7127c85a">Ch</a>* <a class="code" href="../../d6/dbe/portlistingparse_8c.html#a7906a77d388c7c6f7eea5850f61f55e1">str</a>, <a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> length, <span class="keywordtype">bool</span> <a class="code" href="../../d3/d65/namespacerct.html#ad77d0fb2279743febea3fb652f96c77b">copy</a>);</div><div class="line">    <span class="keywordtype">bool</span> String(<span class="keyword">const</span> <a class="code" href="../../d8/df3/sha512-blocks_8c.html#ab0a0d1ad13c7e4d3cb38c89f7127c85a">Ch</a>* <a class="code" href="../../d6/dbe/portlistingparse_8c.html#a7906a77d388c7c6f7eea5850f61f55e1">str</a>, <a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> length, <span class="keywordtype">bool</span> <a class="code" href="../../d3/d65/namespacerct.html#ad77d0fb2279743febea3fb652f96c77b">copy</a>);</div><div class="line">    <span class="keywordtype">bool</span> StartObject();</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d0/d75/namespacetesting.html#a6212e76b542f4ffd3079de59092a826a">Key</a>(<span class="keyword">const</span> <a class="code" href="../../d8/df3/sha512-blocks_8c.html#ab0a0d1ad13c7e4d3cb38c89f7127c85a">Ch</a>* <a class="code" href="../../d6/dbe/portlistingparse_8c.html#a7906a77d388c7c6f7eea5850f61f55e1">str</a>, <a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> length, <span class="keywordtype">bool</span> <a class="code" href="../../d3/d65/namespacerct.html#ad77d0fb2279743febea3fb652f96c77b">copy</a>);</div><div class="line">    <span class="keywordtype">bool</span> EndObject(<a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> memberCount);</div><div class="line">    <span class="keywordtype">bool</span> StartArray();</div><div class="line">    <span class="keywordtype">bool</span> EndArray(<a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> elementCount);</div><div class="line">};</div></div><!-- fragment --><p><code><a class="el" href="../../d5/d14/namespacerandomx_1_1ExecutionPort.html#a1732431f7d93bacc6861edbe71154449">Null()</a></code> is called when the <code>Reader</code> encounters a JSON null value.</p>
<p><code><a class="el" href="../../d9/d2b/structBool.html">Bool(bool)</a></code> is called when the <code>Reader</code> encounters a JSON true or false value.</p>
<p>When the <code>Reader</code> encounters a JSON number, it chooses a suitable C++ type mapping. And then it calls <em>one</em> function out of <code>Int(int)</code>, <code>Uint(unsigned)</code>, <code>Int64(int64_t)</code>, <code>Uint64(uint64_t)</code> and <code>Double(double)</code>. If <code>kParseNumbersAsStrings</code> is enabled, <code>Reader</code> will always calls <code>RawNumber()</code> instead.</p>
<p><code>String(const char* str, SizeType length, bool copy)</code> is called when the <code>Reader</code> encounters a string. The first parameter is pointer to the string. The second parameter is the length of the string (excluding the null terminator). Note that RapidJSON supports null character <code>\0</code> inside a string. If such situation happens, <code>strlen(str) &lt; length</code>. The last <code>copy</code> indicates whether the handler needs to make a copy of the string. For normal parsing, <code>copy = true</code>. Only when <em>insitu</em> parsing is used, <code>copy = false</code>. And be aware that the character type depends on the target encoding, which will be explained later.</p>
<p>When the <code>Reader</code> encounters the beginning of an object, it calls <code>StartObject()</code>. An object in JSON is a set of name-value pairs. If the object contains members it first calls <code><a class="el" href="../../d0/d75/namespacetesting.html#a6212e76b542f4ffd3079de59092a826a">Key()</a></code> for the name of member, and then calls functions depending on the type of the value. These calls of name-value pairs repeat until calling <code>EndObject(SizeType memberCount)</code>. Note that the <code>memberCount</code> parameter is just an aid for the handler; users who do not need this parameter may ignore it.</p>
<p>Arrays are similar to objects, but simpler. At the beginning of an array, the <code>Reader</code> calls <code>BeginArray()</code>. If there is elements, it calls functions according to the types of element. Similarly, in the last call <code>EndArray(SizeType elementCount)</code>, the parameter <code>elementCount</code> is just an aid for the handler.</p>
<p>Every handler function returns a <code>bool</code>. Normally it should return <code>true</code>. If the handler encounters an error, it can return <code>false</code> to notify the event publisher to stop further processing.</p>
<p>For example, when we parse a JSON with <code>Reader</code> and the handler detects that the JSON does not conform to the required schema, the handler can return <code>false</code> and let the <code>Reader</code> stop further parsing. This will place the <code>Reader</code> in an error state, with error code <code>kParseErrorTermination</code>.</p>
<h2><a class="anchor" id="GenericReader"></a>
GenericReader</h2>
<p>As mentioned before, <code>Reader</code> is a typedef of a template class <code><a class="el" href="../../dc/d9e/classGenericReader.html" title="SAX-style JSON parser. Use Reader for UTF8 encoding and default allocator. ">GenericReader</a></code>:</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="../../d1/dc3/namespacerapidjson.html">rapidjson</a> {</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> SourceEncoding, <span class="keyword">typename</span> TargetEncoding, <span class="keyword">typename</span> Allocator = MemoryPoolAllocator&lt;&gt; &gt;</div><div class="line"><span class="keyword">class </span><a class="code" href="../../dc/d9e/classGenericReader.html">GenericReader</a> {</div><div class="line">    <span class="comment">// ...</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <a class="code" href="../../dc/d9e/classGenericReader.html">GenericReader&lt;UTF8&lt;&gt;</a>, <a class="code" href="../../dd/dd8/structUTF8.html">UTF8&lt;&gt;</a> &gt; <a class="code" href="../../d4/d2d/external_2rapidjson_2include_2rapidjson_2fwd_8h.html#ab7f1c1207749ff25c0d7f0cc88e62788">Reader</a>;</div><div class="line"></div><div class="line">} <span class="comment">// namespace rapidjson</span></div></div><!-- fragment --><p>The <code>Reader</code> uses UTF-8 as both source and target encoding. The source encoding means the encoding in the JSON stream. The target encoding means the encoding of the <code>str</code> parameter in <code>String()</code> calls. For example, to parse a UTF-8 stream and output UTF-16 string events, you can define a reader by:</p>
<div class="fragment"><div class="line"><a class="code" href="../../dc/d9e/classGenericReader.html">GenericReader&lt;UTF8&lt;&gt;</a>, <a class="code" href="../../d2/d54/structUTF16.html">UTF16&lt;&gt;</a> &gt; reader;</div></div><!-- fragment --><p>Note that, the default character type of <code><a class="el" href="../../d2/d54/structUTF16.html" title="UTF-16 encoding. ">UTF16</a></code> is <code>wchar_t</code>. So this <code>reader</code> needs to call <code>String(const wchar_t*, SizeType, bool)</code> of the handler.</p>
<p>The third template parameter <code>Allocator</code> is the allocator type for internal data structure (actually a stack).</p>
<h2><a class="anchor" id="SaxParsing"></a>
Parsing</h2>
<p>The main function of <code>Reader</code> is used to parse JSON.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">unsigned</span> parseFlags, <span class="keyword">typename</span> InputStream, <span class="keyword">typename</span> Handler&gt;</div><div class="line"><span class="keywordtype">bool</span> Parse(InputStream&amp; is, Handler&amp; handler);</div><div class="line"></div><div class="line"><span class="comment">// with parseFlags = kDefaultParseFlags</span></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> InputStream, <span class="keyword">typename</span> Handler&gt;</div><div class="line"><span class="keywordtype">bool</span> Parse(InputStream&amp; is, Handler&amp; handler);</div></div><!-- fragment --><p>If an error occurs during parsing, it will return <code>false</code>. User can also call <code>bool HasParseError()</code>, <code>ParseErrorCode GetParseErrorCode()</code> and <code>size_t GetErrorOffset()</code> to obtain the error states. In fact, <code>Document</code> uses these <code>Reader</code> functions to obtain parse errors. Please refer to <a class="el" href="../../d5/df1/dom_8md.html">DOM</a> for details about parse errors.</p>
<h2><a class="anchor" id="TokenByTokenParsing"></a>
Token-by-Token Parsing</h2>
<p>Some users may wish to parse a JSON input stream a single token at a time, instead of immediately parsing an entire document without stopping. To parse JSON this way, instead of calling <code>Parse</code>, you can use the <code>IterativeParse</code> set of functions:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> IterativeParseInit();</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">unsigned</span> parseFlags, <span class="keyword">typename</span> InputStream, <span class="keyword">typename</span> Handler&gt;</div><div class="line"><span class="keywordtype">bool</span> IterativeParseNext(InputStream&amp; is, Handler&amp; handler);</div><div class="line"></div><div class="line"><span class="keywordtype">bool</span> IterativeParseComplete();</div></div><!-- fragment --><p>Here is an example of iteratively parsing JSON, token by token:</p>
<div class="fragment"><div class="line">reader.<a class="code" href="../../dc/d9e/classGenericReader.html#a7de472eda2ad9de13cfd8c1de74f1754">IterativeParseInit</a>();</div><div class="line"><span class="keywordflow">while</span> (!reader.<a class="code" href="../../dc/d9e/classGenericReader.html#aa1e9e1eef614fde971550ed2f955151d">IterativeParseComplete</a>()) {</div><div class="line">    reader.<a class="code" href="../../dc/d9e/classGenericReader.html#a257891331e0c259903e7066fb4cebf92">IterativeParseNext</a>&lt;<a class="code" href="../../d6/dda/reader_8h.html#ab7be7dabe6ffcba60fad441505583450a9104b0946d648e9467cb7a967401ec80">kParseDefaultFlags</a>&gt;(is, handler);</div><div class="line">    <span class="comment">// Your handler has been called once.</span></div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="Writer"></a>
Writer</h1>
<p><code>Reader</code> converts (parses) JSON into events. <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> does exactly the opposite. It converts events into JSON.</p>
<p><code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> is very easy to use. If your application only need to converts some data into JSON, it may be a good choice to use <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> directly, instead of building a <code>Document</code> and then stringifying it with a <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code>.</p>
<p>In <code>simplewriter</code> example, we do exactly the reverse of <code>simplereader</code>.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d9/d53/writer_8h.html">rapidjson/writer.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d7/dde/stringbuffer_8h.html">rapidjson/stringbuffer.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="../../d1/dc3/namespacerapidjson.html">rapidjson</a>;</div><div class="line"><span class="keyword">using namespace </span><a class="code" href="../../d8/dcc/namespacestd.html">std</a>;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="../../d2/dd2/CheckLinkerFlag_8c.html#adacbe0175a79dff748855d8c9839f82b">main</a>() {</div><div class="line">    <a class="code" href="../../d7/d69/classGenericStringBuffer.html">StringBuffer</a> <a class="code" href="../../de/dc6/minissdp_8c.html#ab87f55bd0280d90925050a4188c14ab5">s</a>;</div><div class="line">    <a class="code" href="../../d0/d88/classWriter.html">Writer&lt;StringBuffer&gt;</a> writer(s);</div><div class="line"></div><div class="line">    writer.StartObject();</div><div class="line">    writer.Key(<span class="stringliteral">&quot;hello&quot;</span>);</div><div class="line">    writer.String(<span class="stringliteral">&quot;world&quot;</span>);</div><div class="line">    writer.Key(<span class="stringliteral">&quot;t&quot;</span>);</div><div class="line">    writer.Bool(<span class="keyword">true</span>);</div><div class="line">    writer.Key(<span class="stringliteral">&quot;f&quot;</span>);</div><div class="line">    writer.Bool(<span class="keyword">false</span>);</div><div class="line">    writer.Key(<span class="stringliteral">&quot;n&quot;</span>);</div><div class="line">    writer.Null();</div><div class="line">    writer.Key(<span class="stringliteral">&quot;i&quot;</span>);</div><div class="line">    writer.Uint(123);</div><div class="line">    writer.Key(<span class="stringliteral">&quot;pi&quot;</span>);</div><div class="line">    writer.Double(3.1416);</div><div class="line">    writer.Key(<span class="stringliteral">&quot;a&quot;</span>);</div><div class="line">    writer.StartArray();</div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a2c17f82375a6691bffaa1927a2247b28">i</a> = 0; <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a2c17f82375a6691bffaa1927a2247b28">i</a> &lt; 4; <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a2c17f82375a6691bffaa1927a2247b28">i</a>++)</div><div class="line">        writer.Uint(<a class="code" href="../../d5/dd5/namespacepymoduletest.html#a2c17f82375a6691bffaa1927a2247b28">i</a>);</div><div class="line">    writer.EndArray();</div><div class="line">    writer.EndObject();</div><div class="line"></div><div class="line">    cout &lt;&lt; s.<a class="code" href="../../d7/d69/classGenericStringBuffer.html#ab06b8c5f1385bd3dfd4caea8b7510f0b">GetString</a>() &lt;&lt; endl;</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line">{&quot;hello&quot;:&quot;world&quot;,&quot;t&quot;:true,&quot;f&quot;:false,&quot;n&quot;:null,&quot;i&quot;:123,&quot;pi&quot;:3.1416,&quot;a&quot;:[0,1,2,3]}</div></div><!-- fragment --><p>There are two <code>String()</code> and <code><a class="el" href="../../d0/d75/namespacetesting.html#a6212e76b542f4ffd3079de59092a826a">Key()</a></code> overloads. One is the same as defined in handler concept with 3 parameters. It can handle string with null characters. Another one is the simpler version used in the above example.</p>
<p>Note that, the example code does not pass any parameters in <code>EndArray()</code> and <code>EndObject()</code>. An <code>SizeType</code> can be passed but it will be simply ignored by <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code>.</p>
<p>You may doubt that, why not just using <code>sprintf()</code> or <code>std::stringstream</code> to build a JSON?</p>
<p>There are various reasons:</p><ol type="1">
<li><code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> must output a well-formed JSON. If there is incorrect event sequence (e.g. <code>Int()</code> just after <code>StartObject()</code>), it generates assertion fail in debug mode.</li>
<li><code><a class="el" href="../../d0/d88/classWriter.html#a8b4dc44f471403a83c9959575796ceab">Writer::String()</a></code> can handle string escaping (e.g. converting code point <code>U+000A</code> to <code>\n</code>) and Unicode transcoding.</li>
<li><code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> handles number output consistently.</li>
<li><code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> implements the event handler concept. It can be used to handle events from <code>Reader</code>, <code>Document</code> or other event publisher.</li>
<li><code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> can be optimized for different platforms.</li>
</ol>
<p>Anyway, using <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> API is even simpler than generating a JSON by ad hoc methods.</p>
<h2><a class="anchor" id="WriterTemplate"></a>
Template</h2>
<p><code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> has a minor design difference to <code>Reader</code>. <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> is a template class, not a typedef. There is no <code>GenericWriter</code>. The following is the declaration.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code" href="../../d1/dc3/namespacerapidjson.html">rapidjson</a> {</div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> OutputStream, <span class="keyword">typename</span> SourceEncoding = UTF8&lt;&gt;, <span class="keyword">typename</span> TargetEncoding = UTF8&lt;&gt;, <span class="keyword">typename</span> Allocator = CrtAllocator&lt;&gt;, <span class="keywordtype">unsigned</span> writeFlags = kWriteDefaultFlags&gt;</div><div class="line"><span class="keyword">class </span><a class="code" href="../../d0/d88/classWriter.html">Writer</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <a class="code" href="../../d0/d88/classWriter.html">Writer</a>(OutputStream&amp; os, Allocator* allocator = 0, <span class="keywordtype">size_t</span> levelDepth = kDefaultLevelDepth)</div><div class="line"><span class="comment">// ...</span></div><div class="line">};</div><div class="line"></div><div class="line">} <span class="comment">// namespace rapidjson</span></div></div><!-- fragment --><p>The <code>OutputStream</code> template parameter is the type of output stream. It cannot be deduced and must be specified by user.</p>
<p>The <code>SourceEncoding</code> template parameter specifies the encoding to be used in <code>String(const Ch*, ...)</code>.</p>
<p>The <code>TargetEncoding</code> template parameter specifies the encoding in the output stream.</p>
<p>The <code>Allocator</code> is the type of allocator, which is used for allocating internal data structure (a stack).</p>
<p>The <code>writeFlags</code> are combination of the following bit-flags:</p>
<table class="doxtable">
<tr>
<th>Parse flags </th><th>Meaning  </th></tr>
<tr>
<td><code>kWriteNoFlags</code> </td><td>No flag is set. </td></tr>
<tr>
<td><code>kWriteDefaultFlags</code> </td><td>Default write flags. It is equal to macro <code>RAPIDJSON_WRITE_DEFAULT_FLAGS</code>, which is defined as <code>kWriteNoFlags</code>. </td></tr>
<tr>
<td><code>kWriteValidateEncodingFlag</code> </td><td>Validate encoding of JSON strings. </td></tr>
<tr>
<td><code>kWriteNanAndInfFlag</code> </td><td>Allow writing of <code>Infinity</code>, <code>-Infinity</code> and <code>NaN</code>. </td></tr>
</table>
<p>Besides, the constructor of <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> has a <code>levelDepth</code> parameter. This parameter affects the initial memory allocated for storing information per hierarchy level.</p>
<h2><a class="anchor" id="PrettyWriter"></a>
PrettyWriter</h2>
<p>While the output of <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> is the most condensed JSON without white-spaces, suitable for network transfer or storage, it is not easily readable by human.</p>
<p>Therefore, RapidJSON provides a <code><a class="el" href="../../de/d4f/classPrettyWriter.html" title="Writer with indentation and spacing. ">PrettyWriter</a></code>, which adds indentation and line feeds in the output.</p>
<p>The usage of <code><a class="el" href="../../de/d4f/classPrettyWriter.html" title="Writer with indentation and spacing. ">PrettyWriter</a></code> is exactly the same as <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code>, expect that <code><a class="el" href="../../de/d4f/classPrettyWriter.html" title="Writer with indentation and spacing. ">PrettyWriter</a></code> provides a <code>SetIndent(Ch indentChar, unsigned indentCharCount)</code> function. The default is 4 spaces.</p>
<h2><a class="anchor" id="CompletenessReset"></a>
Completeness and Reset</h2>
<p>A <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> can only output a single JSON, which can be any JSON type at the root. Once the singular event for root (e.g. <code>String()</code>), or the last matching <code>EndObject()</code> or <code>EndArray()</code> event, is handled, the output JSON is well-formed and complete. User can detect this state by calling <code><a class="el" href="../../d0/d88/classWriter.html#a07d74d36dd3191b06e0aab678c246157" title="Checks whether the output is a complete JSON. ">Writer::IsComplete()</a></code>.</p>
<p>When a JSON is complete, the <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> cannot accept any new events. Otherwise the output will be invalid (i.e. having more than one root). To reuse the <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> object, user can call <code><a class="el" href="../../d0/d88/classWriter.html#a8b53e8f137f7fcf694f5500711b3f58d" title="Reset the writer with a new stream. ">Writer::Reset(OutputStream&amp; os)</a></code> to reset all internal states of the <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> with a new output stream.</p>
<h1><a class="anchor" id="SaxTechniques"></a>
Techniques</h1>
<h2><a class="anchor" id="CustomDataStructure"></a>
Parsing JSON to Custom Data Structure</h2>
<p><code>Document</code>'s parsing capability is completely based on <code>Reader</code>. Actually <code>Document</code> is a handler which receives events from a reader to build a DOM during parsing.</p>
<p>User may uses <code>Reader</code> to build other data structures directly. This eliminates building of DOM, thus reducing memory and improving performance.</p>
<p>In the following <code>messagereader</code> example, <code><a class="el" href="../../d5/d3c/messagereader_8cpp.html#a5cd118312f7d5b3983499e2934611ebf">ParseMessages()</a></code> parses a JSON which should be an object with key-string pairs.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d6/dda/reader_8h.html">rapidjson/reader.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../de/d76/en_8h.html">rapidjson/error/en.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;map&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="../../d8/dcc/namespacestd.html">std</a>;</div><div class="line"><span class="keyword">using namespace </span><a class="code" href="../../d1/dc3/namespacerapidjson.html">rapidjson</a>;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> map&lt;string, string&gt; <a class="code" href="../../d5/d3c/messagereader_8cpp.html#ae2c5980b5eb04369faa7f72447e6d664">MessageMap</a>;</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="../../dc/df8/structMessageHandler.html">MessageHandler</a></div><div class="line">    : <span class="keyword">public</span> <a class="code" href="../../d0/d14/structBaseReaderHandler.html">BaseReaderHandler</a>&lt;UTF8&lt;&gt;, MessageHandler&gt; {</div><div class="line">    <a class="code" href="../../dc/df8/structMessageHandler.html">MessageHandler</a>() : state_(kExpectObjectStart) {</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> StartObject() {</div><div class="line">        <span class="keywordflow">switch</span> (state_) {</div><div class="line">        <span class="keywordflow">case</span> kExpectObjectStart:</div><div class="line">            state_ = kExpectNameOrObjectEnd;</div><div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> String(<span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="../../d6/dbe/portlistingparse_8c.html#a7906a77d388c7c6f7eea5850f61f55e1">str</a>, <a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> length, <span class="keywordtype">bool</span>) {</div><div class="line">        <span class="keywordflow">switch</span> (state_) {</div><div class="line">        <span class="keywordflow">case</span> kExpectNameOrObjectEnd:</div><div class="line">            <a class="code" href="../../dc/d35/external_2rapidjson_2thirdparty_2gtest_2googletest_2src_2gtest_8cc.html#a4d739cc5d335052eb9f5b2ca559b81d1">name_</a> = <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a5ca8a348395a6145775c1a2334e21889">string</a>(str, length);</div><div class="line">            state_ = kExpectValue;</div><div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keywordflow">case</span> kExpectValue:</div><div class="line">            messages_.insert(MessageMap::value_type(<a class="code" href="../../dc/d35/external_2rapidjson_2thirdparty_2gtest_2googletest_2src_2gtest_8cc.html#a4d739cc5d335052eb9f5b2ca559b81d1">name_</a>, <span class="keywordtype">string</span>(str, length)));</div><div class="line">            state_ = kExpectNameOrObjectEnd;</div><div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> EndObject(<a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a>) { <span class="keywordflow">return</span> state_ == kExpectNameOrObjectEnd; }</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../da/d7e/namespaceel.html#adb2101973823b0de85b6cffb43923a99a7a1920d61156abc05a60135aefe8bc67">Default</a>() { <span class="keywordflow">return</span> <span class="keyword">false</span>; } <span class="comment">// All other events are invalid.</span></div><div class="line"></div><div class="line">    MessageMap messages_;</div><div class="line">    <span class="keyword">enum</span> State {</div><div class="line">        kExpectObjectStart,</div><div class="line">        kExpectNameOrObjectEnd,</div><div class="line">        kExpectValue,</div><div class="line">    }state_;</div><div class="line">    <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a5ca8a348395a6145775c1a2334e21889">std::string</a> <a class="code" href="../../dc/d35/external_2rapidjson_2thirdparty_2gtest_2googletest_2src_2gtest_8cc.html#a4d739cc5d335052eb9f5b2ca559b81d1">name_</a>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="../../d5/d3c/messagereader_8cpp.html#a5cd118312f7d5b3983499e2934611ebf">ParseMessages</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* json, MessageMap&amp; messages) {</div><div class="line">    <a class="code" href="../../dc/d9e/classGenericReader.html">Reader</a> reader;</div><div class="line">    <a class="code" href="../../dc/df8/structMessageHandler.html">MessageHandler</a> handler;</div><div class="line">    <a class="code" href="../../d2/d8a/structGenericStringStream.html">StringStream</a> ss(json);</div><div class="line">    <span class="keywordflow">if</span> (reader.<a class="code" href="../../dc/d9e/classGenericReader.html#a0c450620d14ff1824e58bb7bd9b42099">Parse</a>(ss, handler))</div><div class="line">        messages.swap(handler.<a class="code" href="../../dc/df8/structMessageHandler.html#a628b5a49349a2027c84ffb4f6249fa51">messages_</a>);   <span class="comment">// Only change it if success.</span></div><div class="line">    <span class="keywordflow">else</span> {</div><div class="line">        <a class="code" href="../../df/d82/group__RAPIDJSON__ERRORS.html#ga8d4b32dfc45840bca189ade2bbcb6ba7">ParseErrorCode</a> <a class="code" href="../../d5/dd5/namespacepymoduletest.html#ab2f9c86c48b23e2100d0574cbc00c5b0">e</a> = reader.<a class="code" href="../../dc/d9e/classGenericReader.html#a937bf90919f50e1c370b312cee5833e8">GetParseErrorCode</a>();</div><div class="line">        <span class="keywordtype">size_t</span> o = reader.<a class="code" href="../../dc/d9e/classGenericReader.html#ae9008523ccd06d839a57335835cb4091">GetErrorOffset</a>();</div><div class="line">        cout &lt;&lt; <span class="stringliteral">&quot;Error: &quot;</span> &lt;&lt; <a class="code" href="../../df/d82/group__RAPIDJSON__ERRORS.html#ga755b523205f46c980c80d12e230a3abd">GetParseError_En</a>(e) &lt;&lt; endl;;</div><div class="line">        cout &lt;&lt; <span class="stringliteral">&quot; at offset &quot;</span> &lt;&lt; o &lt;&lt; <span class="stringliteral">&quot; near &#39;&quot;</span> &lt;&lt; <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a5ca8a348395a6145775c1a2334e21889">string</a>(json).substr(o, 10) &lt;&lt; <span class="stringliteral">&quot;...&#39;&quot;</span> &lt;&lt; endl;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="../../d2/dd2/CheckLinkerFlag_8c.html#adacbe0175a79dff748855d8c9839f82b">main</a>() {</div><div class="line">    MessageMap messages;</div><div class="line"></div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* json1 = <span class="stringliteral">&quot;{ \&quot;greeting\&quot; : \&quot;Hello!\&quot;, \&quot;farewell\&quot; : \&quot;bye-bye!\&quot; }&quot;</span>;</div><div class="line">    cout &lt;&lt; json1 &lt;&lt; endl;</div><div class="line">    <a class="code" href="../../d5/d3c/messagereader_8cpp.html#a5cd118312f7d5b3983499e2934611ebf">ParseMessages</a>(json1, messages);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (MessageMap::const_iterator itr = messages.begin(); itr != messages.end(); ++itr)</div><div class="line">        cout &lt;&lt; itr-&gt;first &lt;&lt; <span class="stringliteral">&quot;: &quot;</span> &lt;&lt; itr-&gt;second &lt;&lt; endl;</div><div class="line"></div><div class="line">    cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;Parse a JSON with invalid schema.&quot;</span> &lt;&lt; endl;</div><div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* json2 = <span class="stringliteral">&quot;{ \&quot;greeting\&quot; : \&quot;Hello!\&quot;, \&quot;farewell\&quot; : \&quot;bye-bye!\&quot;, \&quot;foo\&quot; : {} }&quot;</span>;</div><div class="line">    cout &lt;&lt; json2 &lt;&lt; endl;</div><div class="line">    <a class="code" href="../../d5/d3c/messagereader_8cpp.html#a5cd118312f7d5b3983499e2934611ebf">ParseMessages</a>(json2, messages);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line">{ &quot;greeting&quot; : &quot;Hello!&quot;, &quot;farewell&quot; : &quot;bye-bye!&quot; }</div><div class="line">farewell: bye-bye!</div><div class="line">greeting: Hello!</div><div class="line"></div><div class="line">Parse a JSON with invalid schema.</div><div class="line">{ &quot;greeting&quot; : &quot;Hello!&quot;, &quot;farewell&quot; : &quot;bye-bye!&quot;, &quot;foo&quot; : {} }</div><div class="line">Error: Terminate parsing due to Handler error.</div><div class="line"> at offset 59 near &#39;} }...&#39;</div></div><!-- fragment --><p>The first JSON (<code>json1</code>) was successfully parsed into <code>MessageMap</code>. Since <code>MessageMap</code> is a <code>std::map</code>, the printing order are sorted by the key. This order is different from the JSON's order.</p>
<p>In the second JSON (<code>json2</code>), <code>foo</code>'s value is an empty object. As it is an object, <code><a class="el" href="../../dc/df8/structMessageHandler.html#a3d7e691831748287252e10ced02061f5">MessageHandler::StartObject()</a></code> will be called. However, at that moment <code>state_ = kExpectValue</code>, so that function returns <code>false</code> and cause the parsing process be terminated. The error code is <code>kParseErrorTermination</code>.</p>
<h2><a class="anchor" id="Filtering"></a>
Filtering of JSON</h2>
<p>As mentioned earlier, <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> can handle the events published by <code>Reader</code>. <code>condense</code> example simply set a <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> as handler of a <code>Reader</code>, so it can remove all white-spaces in JSON. <code>pretty</code> example uses the same relationship, but replacing <code><a class="el" href="../../d0/d88/classWriter.html" title="JSON writer. ">Writer</a></code> by <code><a class="el" href="../../de/d4f/classPrettyWriter.html" title="Writer with indentation and spacing. ">PrettyWriter</a></code>. So <code>pretty</code> can be used to reformat a JSON with indentation and line feed.</p>
<p>Actually, we can add intermediate layer(s) to filter the contents of JSON via these SAX-style API. For example, <code>capitalize</code> example capitalize all strings in a JSON.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d6/dda/reader_8h.html">rapidjson/reader.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d9/d53/writer_8h.html">rapidjson/writer.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d1/d0d/filereadstream_8h.html">rapidjson/filereadstream.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d2/d33/filewritestream_8h.html">rapidjson/filewritestream.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../de/d76/en_8h.html">rapidjson/error/en.h</a>&quot;</span></div><div class="line"><span class="preprocessor">#include &lt;vector&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;cctype&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span><a class="code" href="../../d1/dc3/namespacerapidjson.html">rapidjson</a>;</div><div class="line"></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> OutputHandler&gt;</div><div class="line"><span class="keyword">struct </span><a class="code" href="../../db/da7/structCapitalizeFilter.html">CapitalizeFilter</a> {</div><div class="line">    <a class="code" href="../../db/da7/structCapitalizeFilter.html">CapitalizeFilter</a>(OutputHandler&amp; out) : out_(out), buffer_() {</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d5/d14/namespacerandomx_1_1ExecutionPort.html#a1732431f7d93bacc6861edbe71154449">Null</a>() { <span class="keywordflow">return</span> out_.Null(); }</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d9/d2b/structBool.html">Bool</a>(<span class="keywordtype">bool</span> <a class="code" href="../../d9/d4d/block_8cpp.html#a2ea31dd046acb6f7efda9c8ccb0304dc">b</a>) { <span class="keywordflow">return</span> out_.<a class="code" href="../../d9/d2b/structBool.html#a03dfd4851b13abb29414887fcada7fca">Bool</a>(b); }</div><div class="line">    <span class="keywordtype">bool</span> Int(<span class="keywordtype">int</span> <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a2c17f82375a6691bffaa1927a2247b28">i</a>) { <span class="keywordflow">return</span> out_.Int(i); }</div><div class="line">    <span class="keywordtype">bool</span> Uint(<span class="keywordtype">unsigned</span> <a class="code" href="../../d5/dd5/namespacepymoduletest.html#a747820e693705cfaea4159322b20fab8">u</a>) { <span class="keywordflow">return</span> out_.Uint(u); }</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#abd4adb4f2e2d7078a473de91a4089501">Int64</a>(<a class="code" href="../../df/dd8/stdint_8h.html#a414156feea104f8f75b4ed9e3121b2f6">int64_t</a> i) { <span class="keywordflow">return</span> out_.Int64(i); }</div><div class="line">    <span class="keywordtype">bool</span> Uint64(<a class="code" href="../../df/dd8/stdint_8h.html#aec6fcb673ff035718c238c8c9d544c47">uint64_t</a> u) { <span class="keywordflow">return</span> out_.Uint64(u); }</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d0/da7/namespacetesting_1_1internal.html#a92debc9f055b7e7e1e4e861c5ae1c67a">Double</a>(<span class="keywordtype">double</span> d) { <span class="keywordflow">return</span> out_.Double(d); }</div><div class="line">    <span class="keywordtype">bool</span> RawNumber(<span class="keyword">const</span> <span class="keywordtype">char</span>* str, <a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> length, <span class="keywordtype">bool</span> <a class="code" href="../../d3/d65/namespacerct.html#ad77d0fb2279743febea3fb652f96c77b">copy</a>) { <span class="keywordflow">return</span> out_.RawNumber(str, length, copy); }</div><div class="line">    <span class="keywordtype">bool</span> String(<span class="keyword">const</span> <span class="keywordtype">char</span>* str, <a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> length, <span class="keywordtype">bool</span>) { </div><div class="line">        buffer_.clear();</div><div class="line">        <span class="keywordflow">for</span> (<a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> i = 0; i &lt; length; i++)</div><div class="line">            buffer_.push_back(std::toupper(str[i]));</div><div class="line">        <span class="keywordflow">return</span> out_.String(&amp;buffer_.front(), length, <span class="keyword">true</span>); <span class="comment">// true = output handler need to copy the string</span></div><div class="line">    }</div><div class="line">    <span class="keywordtype">bool</span> StartObject() { <span class="keywordflow">return</span> out_.StartObject(); }</div><div class="line">    <span class="keywordtype">bool</span> <a class="code" href="../../d0/d75/namespacetesting.html#a6212e76b542f4ffd3079de59092a826a">Key</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* str, <a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> length, <span class="keywordtype">bool</span> copy) { <span class="keywordflow">return</span> String(str, length, copy); }</div><div class="line">    <span class="keywordtype">bool</span> EndObject(<a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> memberCount) { <span class="keywordflow">return</span> out_.EndObject(memberCount); }</div><div class="line">    <span class="keywordtype">bool</span> StartArray() { <span class="keywordflow">return</span> out_.StartArray(); }</div><div class="line">    <span class="keywordtype">bool</span> EndArray(<a class="code" href="../../d4/dc0/rapidjson_8h.html#a5ed6e6e67250fadbd041127e6386dcb5">SizeType</a> elementCount) { <span class="keywordflow">return</span> out_.EndArray(elementCount); }</div><div class="line"></div><div class="line">    OutputHandler&amp; out_;</div><div class="line">    std::vector&lt;char&gt; buffer_;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="../../d2/dd2/CheckLinkerFlag_8c.html#adacbe0175a79dff748855d8c9839f82b">main</a>(<span class="keywordtype">int</span>, <span class="keywordtype">char</span>*[]) {</div><div class="line">    <span class="comment">// Prepare JSON reader and input stream.</span></div><div class="line">    <a class="code" href="../../dc/d9e/classGenericReader.html">Reader</a> reader;</div><div class="line">    <span class="keywordtype">char</span> readBuffer[65536];</div><div class="line">    <a class="code" href="../../da/da5/classFileReadStream.html">FileReadStream</a> is(stdin, readBuffer, <span class="keyword">sizeof</span>(readBuffer));</div><div class="line"></div><div class="line">    <span class="comment">// Prepare JSON writer and output stream.</span></div><div class="line">    <span class="keywordtype">char</span> writeBuffer[65536];</div><div class="line">    <a class="code" href="../../db/d85/classFileWriteStream.html">FileWriteStream</a> os(<a class="code" href="../../df/ddf/namespacefunctional__tests__rpc.html#aaf95d1a67dfe8fce64b10ed672a03f23">stdout</a>, writeBuffer, <span class="keyword">sizeof</span>(writeBuffer));</div><div class="line">    <a class="code" href="../../d0/d88/classWriter.html">Writer&lt;FileWriteStream&gt;</a> writer(os);</div><div class="line"></div><div class="line">    <span class="comment">// JSON reader parse from the input stream and let writer generate the output.</span></div><div class="line">    <a class="code" href="../../db/da7/structCapitalizeFilter.html">CapitalizeFilter&lt;Writer&lt;FileWriteStream&gt;</a> &gt; filter(writer);</div><div class="line">    <span class="keywordflow">if</span> (!reader.<a class="code" href="../../dc/d9e/classGenericReader.html#a0c450620d14ff1824e58bb7bd9b42099">Parse</a>(is, filter)) {</div><div class="line">        fprintf(<a class="code" href="../../d5/da8/namespacecompare.html#a2790a7b792bd2b99e32b2c55d524279b">stderr</a>, <span class="stringliteral">&quot;\nError(%u): %s\n&quot;</span>, (<span class="keywordtype">unsigned</span>)reader.<a class="code" href="../../dc/d9e/classGenericReader.html#ae9008523ccd06d839a57335835cb4091">GetErrorOffset</a>(), <a class="code" href="../../df/d82/group__RAPIDJSON__ERRORS.html#ga755b523205f46c980c80d12e230a3abd">GetParseError_En</a>(reader.<a class="code" href="../../dc/d9e/classGenericReader.html#a937bf90919f50e1c370b312cee5833e8">GetParseErrorCode</a>()));</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>Note that, it is incorrect to simply capitalize the JSON as a string. For example: </p><div class="fragment"><div class="line">[&quot;Hello\nWorld&quot;]</div></div><!-- fragment --><p>Simply capitalizing the whole JSON would contain incorrect escape character: </p><div class="fragment"><div class="line">[&quot;HELLO\NWORLD&quot;]</div></div><!-- fragment --><p>The correct result by <code>capitalize</code>: </p><div class="fragment"><div class="line">[&quot;HELLO\nWORLD&quot;]</div></div><!-- fragment --><p>More complicated filters can be developed. However, since SAX-style API can only provide information about a single event at a time, user may need to book-keeping the contextual information (e.g. the path from root value, storage of other related values). Some processing may be easier to be implemented in DOM than SAX. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Sep 2 2023 19:23:33 for Monero by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
