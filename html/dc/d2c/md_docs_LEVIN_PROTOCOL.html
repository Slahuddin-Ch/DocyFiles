<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Monero: Levin Protocol</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Monero
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Levin Protocol </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is a document explaining the current design of the Levin protocol, as used by <a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a>. The protocol is largely inherited from cryptonote, but has undergone some changes.</p>
<p>This document also may differ from the <code>struct bucket_head2</code> in <a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a>'s code slightly - the spec here is slightly more strict to allow for extensibility.</p>
<p>One of the goals of this document is to clearly indicate what is being sent "on the wire" to identify metadata that could de-anonymize users over I2P/Tor. These issues will be addressed as they are found. See <code><a class="el" href="../../d3/dab/ANONYMITY__NETWORKS_8md.html">ANONYMITY_NETWORKS.md</a></code> in the <code>docs</code> folder for any outstanding issues.</p>
<blockquote class="doxtable">
<p>This document does not currently list all data being sent by the monero protocol, that portion is a work-in-progress. Please take the time to do it if interested in learning about <a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a> <a class="el" href="../../d1/d5d/namespacep2p.html">p2p</a> traffic! </p>
</blockquote>
<h2>Header</h2>
<p>This header is sent for every <a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a> <a class="el" href="../../d1/d5d/namespacep2p.html">p2p</a> message.</p>
<div class="fragment"><div class="line"> 0               1               2               3</div><div class="line"> 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7</div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|      0x01     |      0x21     |      0x01     |      0x01     |</div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|      0x01     |      0x01     |      0x01     |      0x01     |</div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|                             Length                            |</div><div class="line">|                                                               |</div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|  E. Response  |                   Command</div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">                |                 Return Code</div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">                |Q|S|B|E|               Reserved</div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">                |      0x01     |      0x00     |      0x00     |</div><div class="line">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</div><div class="line">|     0x00      |</div><div class="line">+-+-+-+-+-+-+-+-+</div></div><!-- fragment --><h3>Signature</h3>
<p>The first 8 bytes are the "signature" which helps identify the protocol (in case someone connected to the wrong port, etc). The comments indicate that byte sequence is from "benders nightmare".</p>
<p>This also can be used by deep packet inspection (DPI) engines to identify <a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a> when the link is not encrypted. SSL has been proposed as a means to mitigate this issue, but BIP-151 or the Noise protocol should also be considered.</p>
<h3>Length</h3>
<p>The length is an unsigned 64-bit little endian integer. The length does <em>not</em> include the header.</p>
<p>The implementation currently rejects received messages that exceed 100 MB (base 10) by default.</p>
<h3>Expect Response</h3>
<p>A zero-byte if no response is expected from the peer, and a non-zero byte if a response is expected from the peer. Peers must respond to requests with this flag in the same order that they were received, however, other messages can be sent between responses.</p>
<p>There are some commands in the <a href="../../#cryptonote-protocol-commands">cryptonote protocol</a> where a response is expected from the peer, but this flag is not set. Those responses are returned as notify messages and can be sent in any order by the peer.</p>
<h3>Command</h3>
<p>An unsigned 32-bit little endian integer representing the <a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a> specific command being invoked.</p>
<h3>Return Code</h3>
<p>A signed 32-bit little endian integer representing the response from the peer from the last command that was invoked. This is <code>0</code> for request messages.</p>
<h3>Flags</h3>
<ul>
<li><code>Q</code> - Bit is set if the message is a request.</li>
<li><code>S</code> - Bit is set if the message is a response.</li>
<li><code>B</code> - Bit is set if this is a the beginning of a <a href="../../#fragmented-messages">fragmented message</a>.</li>
<li><code>E</code> - Bit is set if this is the end of a <a href="../../#fragmented-messages">fragmented message</a>.</li>
</ul>
<h3>Version</h3>
<p>A fixed value of <code>1</code> as an unsigned 32-bit little endian integer.</p>
<h2>Message Flow</h2>
<p>The protocol can be subdivided into: (1) notifications, (2) requests, (3) responses, (4) fragmented messages, and (5) dummy messages. Response messages must be sent in the same order that a peer issued a request message. A peer does not have to send a response immediately following a request - any other message type can be sent instead.</p>
<h3>Notifications</h3>
<p>Notifications are one-way messages that can be sent at any time without an expectation of a response from the peer. The <code>Q</code> bit must be set, the <code>S</code>, <code>B</code> and <code>E</code> bits must be unset, and the <code>Expect Response</code> field must be zeroed.</p>
<p>Some notifications must be in response to other notifications. This is not part of the levin messaging layer, and is described in the <a href="../../#commands">commands</a> section.</p>
<h3>Requests</h3>
<p>Requests are the basis of the admin protocol for <a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a>. The <code>Q</code> bit must be set, the <code>S</code>, <code>B</code> and <code>E</code> bits must be unset, and the <code>Expect Response</code> field must be non-zero. The peer is expected to send a response message with the same <code>command</code> number.</p>
<h3>Responses</h3>
<p>Response message can only be sent after a peer first issues a request message. Responses must have the <code>S</code> bit set, the <code>Q</code>, <code>B</code> and <code>E</code> bits unset, and have a zeroed <code>Expect Response</code> field. The <code>Command</code> field must be the same value that was sent in the request message. The <code>Return Code</code> is specific to the <code>Command</code> being issued (see [commands])(#commands)).</p>
<h3>Fragmented</h3>
<p>Fragmented messages were introduced for the "white noise" feature for i2p/tor. A transaction can be sent in fragments to conceal when "real" data is being sent instead of dummy messages. Only one fragmented message can be sent at a time, and bits <code>B</code> and <code>E</code> are never set at the same time (see <a href="../../#dummy">dummy messages</a>). The re-constructed message must contain a levin header for a different (non-fragment) message type.</p>
<p>The <code>Q</code> and <code>S</code> bits are never set and the <code>Expect Response</code> field must always be zero. The first fragment has the <code>B</code> bit set, neither <code>B</code> nor <code>E</code> is set for "middle" fragments, and <code>E</code> is set for the last fragment.</p>
<h3>Dummy</h3>
<p>Dummy messages have the <code>B</code> and <code>E</code> bits set, the <code>Q</code> and <code>S</code> bits unset, and the <code>Expect Response</code> field zeroed. When a message of this type is received, the contents can be safely ignored.</p>
<h2>Commands</h2>
<h3>P2P (Admin) Commands</h3>
<h4>(<code>1001</code> Request) Handshake</h4>
<h4>(<code>1001</code> Response) Handshake</h4>
<h4>(<code>1002</code> Request) Timed Sync</h4>
<h4>(<code>1002</code> Response) Timed Sync</h4>
<h4>(<code>1003</code> Request) Ping</h4>
<h4>(<code>1003</code> Response) Ping</h4>
<h4>(<code>1004</code> Request) Stat Info</h4>
<h4>(<code>1004</code> Response) Stat Info</h4>
<h4>(<code>1005</code> Request) Network State</h4>
<h4>(<code>1005</code> Response) Network State</h4>
<h4>(<code>1006</code> Request) Peer ID</h4>
<h4>(<code>1006</code> Response) Peer ID</h4>
<h4>(<code>1007</code> Request) Support Flags</h4>
<h4>(<code>1007</code> Response) Support Flags</h4>
<h3>Cryptonote Protocol Commands</h3>
<h4>(<code>2001</code> Notification) New Block</h4>
<h4>(<code>2002</code> Notification) New Transactions</h4>
<h4>(<code>2003</code> Notification) Request Get Objects</h4>
<h4>(<code>2004</code> Notification) Response Get Objects</h4>
<h4>(<code>2006</code> Notification) Request Chain</h4>
<h4>(<code>2007</code> Notification) Response Chain Entry</h4>
<h4>(<code>2008</code> Notification) New Fluffy Block</h4>
<h4>(<code>2009</code> Notification) Request Fluffy Missing TX</h4>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Sep 2 2023 19:23:33 for Monero by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
