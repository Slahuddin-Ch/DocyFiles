<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Monero: Gitian building</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Monero
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Gitian building </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><em>Setup instructions for a Gitian build of <a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a>.</em></p>
<p>Gitian is the deterministic build process that is used to build the <a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a> CLI executables. It provides a way to be reasonably sure that the executables are really built from the git source. It also makes sure that the same, tested dependencies are used and statically built into the executable.</p>
<p>Multiple developers build the source code by following a specific descriptor ("recipe"), cryptographically sign the result, and upload the resulting signature. These results are compared and only if they match, the build is accepted and provided for download.</p>
<p>Gitian runs compilation steps in an isolated container. It is flexible and gives you full control over the build environment, while still ensuring reproducibility and consistent output formats.</p>
<p>More independent Gitian builders are needed, which is why this guide exists. It is preferred you follow these steps yourself instead of using someone else's VM image to avoid 'contaminating' the build.</p>
<h2>Preparing the Gitian builder host </h2>
<p>The first step is to prepare the host environment that will be used to perform the Gitian builds. This guide explains how to set up the environment, and how to start the builds.</p>
<ul>
<li>Gitian host OS should be Ubuntu 18.04 "Bionic Beaver". If you are on a mac or windows for example, you can run it in a VM but will be slower.</li>
<li>Gitian gives you the option of using any of 3 different virtualization tools: <code>kvm</code>, <code>docker</code> or <code>lxc</code>. This documentation will only show how to build with <code>lxc</code> and <code>docker</code> (documentation for <code>kvm</code> is welcome). Building with <code>lxc</code> is the default, but is more complicated, so we recommend docker your first time.</li>
<li>For a shortcut using <code>docker</code> follow the instructions in <a class="el" href="../../db/df2/DOCKRUN_8md.html">DOCKRUN.md</a> instead of following the rest of this document..</li>
</ul>
<h2>Create the gitianuser account</h2>
<p>You need to create a new user called <code>gitianuser</code> and be logged in as that user. The user needs <code>sudo</code> access.</p>
<div class="fragment"><div class="line">sudo adduser gitianuser</div><div class="line">sudo usermod -aG sudo gitianuser</div></div><!-- fragment --><h2>LXC </h2>
<p>LXC builds should be run on Ubuntu 18.04 "Bionic Beaver".</p>
<p>Note that a version of <code>lxc-execute</code> higher or equal to 2.1.1 is required. You can check the version with <code>lxc-execute --version</code>.</p>
<p>First we need to set up dependencies. Type/paste the following in the terminal:</p>
<div class="fragment"><div class="line">sudo apt-get install git ruby apt-cacher-ng qemu-utils debootstrap lxc python-cheetah parted kpartx bridge-utils make ubuntu-archive-keyring curl firewalld</div></div><!-- fragment --><p>Then set up LXC and the rest with the following, which is a complex jumble of settings and workarounds:</p>
<div class="fragment"><div class="line">sudo -s</div><div class="line"># the version of lxc-start in Debian needs to run as root, so make sure</div><div class="line"># that the build script can execute it without providing a password</div><div class="line">echo &quot;%sudo ALL=NOPASSWD: /usr/bin/lxc-start&quot; &gt; /etc/sudoers.d/gitian-lxc</div><div class="line">echo &quot;%sudo ALL=NOPASSWD: /usr/bin/lxc-execute&quot; &gt;&gt; /etc/sudoers.d/gitian-lxc</div><div class="line"># make /etc/rc.local script that sets up bridge between guest and host</div><div class="line">echo &#39;#!/bin/sh -e&#39; &gt; /etc/rc.local</div><div class="line">echo &#39;brctl addbr br0&#39; &gt;&gt; /etc/rc.local</div><div class="line">echo &#39;ip addr add 10.0.2.2/24 broadcast 10.0.2.255 dev br0&#39; &gt;&gt; /etc/rc.local</div><div class="line">echo &#39;ip link set br0 up&#39; &gt;&gt; /etc/rc.local</div><div class="line">echo &#39;firewall-cmd --zone=trusted --add-interface=br0&#39; &gt;&gt; /etc/rc.local</div><div class="line">echo &#39;exit 0&#39; &gt;&gt; /etc/rc.local</div><div class="line">chmod +x /etc/rc.local</div><div class="line"># make sure that USE_LXC is always set when logging in as gitianuser,</div><div class="line"># and configure LXC IP addresses</div><div class="line">echo &#39;export USE_LXC=1&#39; &gt;&gt; /home/gitianuser/.profile</div><div class="line">echo &#39;export GITIAN_HOST_IP=10.0.2.2&#39; &gt;&gt; /home/gitianuser/.profile</div><div class="line">echo &#39;export LXC_GUEST_IP=10.0.2.5&#39; &gt;&gt; /home/gitianuser/.profile</div><div class="line">reboot</div></div><!-- fragment --><p>This setup is required to enable networking in the container.</p>
<h2>Docker </h2>
<p>Prepare for building with docker:</p>
<div class="fragment"><div class="line">sudo bash -c &#39;apt-get update &amp;&amp; apt-get upgrade -y &amp;&amp; apt-get install git curl docker.io&#39;</div></div><!-- fragment --><p>Consider adding <code>gitianuser</code> to the <code>docker</code> group after reading about <a href="https://docs.docker.com/v17.09/engine/installation/linux/linux-postinstall/">the security implications</a>:</p>
<div class="fragment"><div class="line">sudo groupadd docker</div><div class="line">sudo usermod -aG docker gitianuser</div></div><!-- fragment --><p>Optionally add yourself to the docker group. Note that this will give docker root access to your system.</p>
<div class="fragment"><div class="line">sudo usermod -aG docker $USER</div></div><!-- fragment --><h2>Manual Building </h2>
<hr/>
<p> The script automatically installs some packages with apt. If you are not running it on a debian-like system, pass <code>--no-apt</code> along with the other arguments to it. It calls all available .yml descriptors, which in turn pass the build configurations for different platforms to gitian. The instructions below use the automated script <a href="../../gitian-build.py">gitian-build.py</a> which is tested to work on Ubuntu.</p>
<p>It calls all available .yml descriptors, which in turn pass the build configurations for different platforms to gitian. Help for the build steps taken can be accessed with <code>./gitian-build.py --help</code>.</p>
<h2>Initial Gitian Setup </h2>
<p>The <code><a class="el" href="../../d0/dad/gitian-build_8py.html">gitian-build.py</a></code> script will checkout different release tags, so it's best to copy it to the top level directory:</p>
<div class="fragment"><div class="line">cp monero/contrib/gitian/gitian-build.py .</div></div><!-- fragment --><h3>Setup the required environment</h3>
<p>Common setup part:</p>
<div class="fragment"><div class="line">su - gitianuser</div><div class="line"></div><div class="line">GH_USER=YOUR_GITHUB_USER_NAME</div><div class="line">VERSION=v0.18.2.2</div></div><!-- fragment --><p>Where <code>GH_USER</code> is your GitHub user name and <code>VERSION</code> is the version tag you want to build. The <code><a class="el" href="../../d0/dad/gitian-build_8py.html">gitian-build.py</a></code>'s <code>--setup</code> switch will also refresh the environment of any stale files and submodules.</p>
<p>Setup for LXC:</p>
<div class="fragment"><div class="line">./gitian-build.py --setup $GH_USER $VERSION</div></div><!-- fragment --><p>Setup for docker:</p>
<div class="fragment"><div class="line">./gitian-build.py --setup --docker $GH_USER $VERSION</div></div><!-- fragment --><p>While gitian and this build script does provide a way for you to sign the build directly, it is recommended to sign in a separate step. This script is only there for convenience. Separate steps for building can still be taken. In order to sign gitian builds on your host machine, which has your PGP key, fork the <a href="https://github.com/monero-project/gitian.sigs">gitian.sigs repository</a> and clone it on your host machine, or pass the signed assert file back to your build machine.</p>
<div class="fragment"><div class="line">git clone https://github.com/monero-project/gitian.sigs/</div><div class="line">pushd gitian.sigs</div><div class="line">git remote add $GH_USER https://github.com/$GH_USER/gitian.sigs</div><div class="line">popd</div></div><!-- fragment --><h2>Build the binaries </h2>
<p>To build the most recent tag (pass in <code>--docker</code> if using docker):</p>
<div class="fragment"><div class="line">./gitian-build.py --detach-sign --no-commit --build $GH_USER $VERSION</div></div><!-- fragment --><p>To speed up the build, use <code>-j 5 --memory 10000</code> as the first arguments, where <code>5</code> is the number of CPU's you allocated to the VM plus one, and 10000 is a little bit less than then the MB's of RAM you allocated. If there is memory corruption on your machine, try to tweak these values. A good rule of thumb is, that <a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a> currently needs about 2 GB of RAM per core.</p>
<p>A full example for <code>docker</code> would look like the following:</p>
<div class="fragment"><div class="line">./gitian-build.py -j 5 --memory 10000 --docker --detach-sign --no-commit --build $GH_USER $VERSION</div></div><!-- fragment --><p>If all went well, this produces a number of (uncommitted) <code>.assert</code> files in the gitian.sigs directory.</p>
<h2>Checking your work </h2>
<p>Take a look in the assert files and note the SHA256 checksums listed there.</p>
<p>You should verify that the checksum that is listed matches each of the binaries you actually built. This may be done on Linux using the <code>sha256sum</code> command or on MacOS using <code>shasum --algorithm 256</code> for example. An example script to verify the checksums would be:</p>
<div class="fragment"><div class="line">pushd out/${VERSION}</div><div class="line"></div><div class="line">for ASSERT in ../../sigs/${VERSION}-*/*/*.assert; do</div><div class="line">  if ! sha256sum --ignore-missing -c &quot;${ASSERT}&quot; ; then</div><div class="line">    echo &quot;FAILED for ${ASSERT} ! Please inspect manually.&quot;</div><div class="line">  fi</div><div class="line">done</div><div class="line"></div><div class="line">popd</div></div><!-- fragment --><p>Don't ignore the incorrect formatting of the found assert files. These files you'll have to compare manually (currently OSX and FreeBSD).</p>
<p>You can also look in the <a href="https://github.com/monero-project/gitian.sigs/">gitian.sigs</a> repo and / or <a href="https://web.getmonero.org/downloads/hashes.txt">getmonero.org release checksums</a> to see if others got the same checksum for the same version tag. If there is ever a mismatch &ndash; <b>STOP! Something is wrong</b>. Contact others on IRC / github to figure out what is going on.</p>
<h2>Signing assert files </h2>
<p>If you chose to do detached signing using <code>--detach-sign</code> above (recommended), you need to copy these uncommitted changes to your host machine, then sign them using your gpg key like so:</p>
<div class="fragment"><div class="line">for ASSERT in sigs/${VERSION}-*/*/*.assert; do gpg --detach-sign ${ASSERT}; done</div></div><!-- fragment --><p>This will create a <code>.sig</code> file for each <code>.assert</code> file above (2 files for each platform).</p>
<h2>Submitting your signed assert files </h2>
<p>Make a pull request (both the <code>.assert</code> and <code>.assert.sig</code> files) to the <a href="https://github.com/monero-project/gitian.sigs/">monero-project/gitian.sigs</a> repository:</p>
<div class="fragment"><div class="line">cd gitian.sigs</div><div class="line">git checkout -b $VERSION</div><div class="line"># add your assert and sig files...</div><div class="line">git commit -S -a -m &quot;Add $GH_USER $VERSION&quot;</div><div class="line">git push --set-upstream $GH_USER $VERSION</div></div><!-- fragment --><p><b>Note:</b> Please ensure your gpg public key is available to check signatures by adding it to the <a href="https://github.com/monero-project/gitian.sigs/tree/master/gitian-pubkeys">gitian.sigs/gitian-pubkeys/</a> directory in a pull request.</p>
<h2>More Build Options </h2>
<p>You can choose your own remote and commit hash by running for example: </p><div class="fragment"><div class="line">./gitian-build.py --detach-sign --no-commit --url https://github.com/moneromooo-monero/bitmonero -b moneromooo 1f5680c8db8f4cc7acc04a04c724b832003440fd</div></div><!-- fragment --><p>Note that you won't be able to build commits authored before the gitian scripts were added. Gitian clones the source files from the given url, be sure to push to the remote you provide before building. To get all build options run: </p><div class="fragment"><div class="line">./gitian-build.py --help</div></div><!-- fragment --><h2>Doing Successive Builds </h2>
<p>If you need to do multiple iterations (while developing/testing) you can use the <code>--rebuild</code> option instead of <code>--build</code> on subsequent iterations. This skips the initial check for the freshness of the depends tools. In particular, doing this check all the time prevents rebuilding when you have no network access.</p>
<h2>Local-Only Builds </h2>
<p>If you need to run builds while disconnected from the internet, make sure you have local up-to-date repos in advance. Then specify your local repo using the <code>--url</code> option when building. This will avoid attempts to git pull across a network. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Sep 2 2023 19:23:33 for Monero by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
