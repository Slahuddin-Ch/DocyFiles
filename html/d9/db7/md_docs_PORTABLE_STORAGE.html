<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Monero: Portable Storage Format</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Monero
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Portable Storage Format </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Background</h2>
<p><a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a> makes use of a set of helper classes from a small library named <a href="https://github.com/monero-project/monero/tree/master/contrib/epee">epee</a>. Part of this library implements a networking protocol called <a href="https://github.com/monero-project/monero/blob/master/contrib/epee/include/net/levin_base.h">Levin</a>, which internally uses a storage format called <a href="https://github.com/monero-project/monero/tree/master/contrib/epee/include/storages">Portable Storage</a>. This format (amongst the rest of the <a href="https://github.com/monero-project/monero/tree/master/contrib/epee">epee</a> library), is undocumented - or rather relies on the code itself to serve as the documentation. Unfortunately, whilst the rest of the library is fairly straightforward to decipher, the Portable Storage is less-so. Hence this document.</p>
<h2>String and Integer Encoding</h2>
<h3>Integers</h3>
<p>With few exceptions, integers serialized in epee portable storage format are serialized as little-endian.</p>
<h3>Varints</h3>
<p>Varints are used to pack integers in an portable and space optimized way. Varints are stored as little-endian integers, with the lowest 2 bits storing the amount of bytes required, which means the largest value integer that can be packed into 1 byte is 63 (6 bits).</p>
<h4>Byte Sizes</h4>
<table class="doxtable">
<tr>
<th>Lowest 2 bits </th><th>Size value </th><th>Value range  </th></tr>
<tr>
<td>b00 </td><td>1 byte </td><td>0 to 63 </td></tr>
<tr>
<td>b01 </td><td>2 bytes </td><td>64 to 16383 </td></tr>
<tr>
<td>b10 </td><td>4 bytes </td><td>16384 to 1073741823 </td></tr>
<tr>
<td>b11 </td><td>8 bytes </td><td>1073741824 to 4611686018427387903 </td></tr>
</table>
<h4>Represenations of Example Values</h4>
<table class="doxtable">
<tr>
<th>Value </th><th>Byte Representation (hex)  </th></tr>
<tr>
<td>0 </td><td>00 </td></tr>
<tr>
<td>7 </td><td>1c </td></tr>
<tr>
<td>101 </td><td>95 01 </td></tr>
<tr>
<td>17,000 </td><td>A2 09 01 00 </td></tr>
<tr>
<td>7,942,319,744 </td><td>03 BA 98 65 07 00 00 00 </td></tr>
</table>
<h3>Strings</h3>
<p>These are simply length (varint) prefixed char strings without a null terminator (though one can always add one if desired). There is no specific encoding enforced, and in fact, many times binary blobs are stored as these strings. This type should not be confused with the keys in sections, as those are restricted to a maximum length of 255 and do not use varints to encode the length. </p><pre class="fragment">"Howdy" =&gt; 14 48 6F 77 64 79
</pre><h3>Section Keys</h3>
<p>These are similar to strings except that they are length limited to 255 bytes, and use a single byte at the front of the string to describe the length (as opposed to a varint). </p><pre class="fragment">"Howdy" =&gt; 05 48 6F 77 64 79
</pre><h2>Binary Format Specification</h2>
<h3>Header</h3>
<p>The format must always start with the following header:</p>
<table class="doxtable">
<tr>
<th>Field </th><th>Type </th><th>Value  </th></tr>
<tr>
<td>Signature Part A </td><td>UInt32 </td><td>0x01011101 </td></tr>
<tr>
<td>Signature Part B </td><td>UInt32 </td><td>0x01020101 </td></tr>
<tr>
<td>Version </td><td>UInt8 </td><td>0x01 </td></tr>
</table>
<p>In total, the 9 byte header will look like this (in hex): <code>01 11 01 01 01 01 02 01 01</code></p>
<h3>Section</h3>
<p>Next we have a root object (or section as the library calls it). This is a map of name-value pairs called <a href="../../#Entry">entries</a>. It starts with a count:</p>
<table class="doxtable">
<tr>
<th>Section </th><th>Type  </th></tr>
<tr>
<td>Entry count </td><td>varint </td></tr>
</table>
<p>Which is followed by the section's name-value <a href="../../#Entry">entries</a> sequentially:</p>
<h3>Entry</h3>
<table class="doxtable">
<tr>
<th>Entry </th><th>Type  </th></tr>
<tr>
<td>Name </td><td>section key </td></tr>
<tr>
<td>Type </td><td>byte </td></tr>
<tr>
<td>Count<sup>1</sup> </td><td>varint </td></tr>
<tr>
<td>Value(s) </td><td>(type dependant data) </td></tr>
</table>
<p><sup>1</sup> Note, this is only present if the entry type has the array flag (see below).</p>
<h4>Entry types</h4>
<p>The types defined are:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_INT64                1</span></div><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_INT32                2</span></div><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_INT16                3</span></div><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_INT8                 4</span></div><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_UINT64               5</span></div><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_UINT32               6</span></div><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_UINT16               7</span></div><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_UINT8                8</span></div><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_DOUBLE               9</span></div><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_STRING               10</span></div><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_BOOL                 11</span></div><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_OBJECT               12</span></div><div class="line"><span class="preprocessor">#define SERIALIZE_TYPE_ARRAY                13</span></div></div><!-- fragment --><p>The entry type can be bitwise OR'ed with a flag:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define SERIALIZE_FLAG_ARRAY              0x80</span></div></div><!-- fragment --><p>This signals there are multiple <em>values</em> for the entry. Since only one bit is reserved for specifying an array, we can not directly represent nested arrays. However, you can place each of the inner arrays inside of a section, and make the outer array type <code>SERIALIZE_TYPE_OBJECT | SERIALIZE_FLAG_ARRAY</code>. Immediately following the type code byte is a varint specifying the length of the array. Finally, the all the elements are serialized in sequence with no padding and without any type information. For example:</p>
<p>type, count, value<sub>1</sub>, value<sub>2</sub>,..., value<sub>n</sub></p>
<h4>Entry values</h4>
<p>It's important to understand that entry <em>values</em> can be encoded any way in which an implementation chooses. For example, the integers can be in either big or little endian byte order.</p>
<p>Entry values which are objects (i.e. <code>SERIALIZE_TYPE_OBJECT</code>), are stored as <a href="../../#Section">sections</a>.</p>
<p>Note, I have not yet seen the type <code>SERIALIZE_TYPE_ARRAY</code> in use. My assumption is this would be used for <em>untyped</em> arrays and so subsequent entries could be of any type.</p>
<h3>Overall example</h3>
<p>Let's put it all together and see what an entire object would look like serialized. To represent our data, let's create a JSON object (since it's a format that most will be familiar with):</p>
<div class="fragment"><div class="line">{</div><div class="line">  &quot;short_quote&quot;: &quot;Give me liberty or give me death!&quot;,</div><div class="line">  &quot;long_quote&quot;: &quot;Monero is more than just a technology. It&#39;s also what the technology stands for.&quot;,</div><div class="line">  &quot;signed_32bit_int&quot;: 20140418,</div><div class="line">  &quot;array_of_bools&quot;: [true, false, true, true],</div><div class="line">  &quot;nested_section&quot;: {</div><div class="line">    &quot;double&quot;: -6.9,</div><div class="line">    &quot;unsigned_64bit_int&quot;: 11111111111111111111</div><div class="line">  }</div><div class="line">}</div></div><!-- fragment --><p>This would translate to:</p>
<div class="image">
<img src="../..//docs/images/storage_binary_example.png" alt="Epee binary storage format example"/>
</div>
<h2><a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a> specifics</h2>
<h3>Entry values</h3>
<h4>Hashes, Keys, Blobs</h4>
<p>These are stored as strings, <code>SERIALIZE_TYPE_STRING</code>.</p>
<h4>STL containers (vector, list)</h4>
<p>These can be arrays of standard integer types, strings or <code>SERIALIZE_TYPE_OBJECT</code>'s for structs.</p>
<h4>Links to some <a class="el" href="../../d1/d5b/namespaceMonero.html">Monero</a> struct definitions</h4>
<ul>
<li><a href="https://github.com/monero-project/monero/blob/master/src/rpc/core_rpc_server_commands_defs.h">Core RPC definitions</a></li>
<li><a href="https://github.com/monero-project/monero/blob/master/src/cryptonote_protocol/cryptonote_protocol_defs.h">CryptoNote protocol definitions</a> </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Sep 2 2023 19:23:33 for Monero by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
